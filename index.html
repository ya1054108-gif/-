<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireLog Lite v4.2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        /* --- 核心樣式 --- */
        :root {
            --bg-body: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text-main: #334155; --text-sub: #64748b;
        }
        .dark {
            --bg-body: #020617; --surface: #1e293b; --border: #334155; --text-main: #f8fafc; --text-sub: #94a3b8;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 110px !important; 
            transition: background-color 0.3s;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }

        /* 視圖切換 */
        .view-panel { display: none; }
        .view-panel.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Header & Nav */
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 40; }
        .dark .glass-header { background: rgba(2, 6, 23, 0.95); }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0 25px 0; z-index: 50; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); font-size: 0.7rem; font-weight: 600; width: 100%; transition: all 0.2s; opacity: 0.6; }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; transition: transform 0.2s; }
        .nav-btn.active { color: #3b82f6; opacity: 1; } .dark .nav-btn.active { color: #60a5fa; }
        .nav-btn.active i { transform: translateY(-2px); }

        /* 輸入框 & 搜尋框修復 */
        input, textarea, select {
            background: var(--surface); border: 1px solid var(--border); color: var(--text-main);
            border-radius: 10px; padding: 12px; width: 100%; 
            font-size: 16px; transition: 0.2s;
        }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15); }

        /* 搜尋框容器 */
        .search-wrapper { position: relative; width: 100%; }
        .search-icon { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #94a3b8; 
            pointer-events: none;
        }
        .search-input { padding-left: 40px !important; }

        /* 按鈕系統 */
        .sys-btn { 
            background: var(--surface); border: 1px solid var(--border); color: var(--text-sub); 
            font-weight: 600; border-radius: 10px; padding: 12px; 
            transition: all 0.1s; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 15px;
        }
        .sys-btn:active { transform: scale(0.96); background: #f1f5f9; }
        .sys-btn.active { background: #334155; color: #fff; border-color: #334155; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .dark .sys-btn.active { background: #3b82f6; border-color: #3b82f6; }

        /* 卡片與列表 (防爆版) */
        .log-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); transition: transform 0.1s;
            overflow: hidden; /* 關鍵：防止內容溢出 */
            display: flex; flex-direction: column; gap: 4px;
        }
        .log-card:active { transform: scale(0.98); background: #f8fafc; }
        .border-l-fire { border-left: 4px solid #ef4444; }
        .border-l-ems { border-left: 4px solid #0d9488; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .card-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-sub { font-size: 0.85rem; color: var(--text-sub); font-family: 'JetBrains Mono', monospace; display: flex; gap: 8px; align-items: center;}

        /* Tag Scroll */
        .tag-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: none; }
        .tag-btn { font-size: 0.8rem; padding: 6px 12px; border-radius: 99px; background: var(--surface); color: var(--text-sub); border: 1px solid var(--border); white-space: nowrap; font-weight: 500; }
        .tag-btn.active { background: #334155; color: white; border-color: #334155; }
        .dark .tag-btn.active { background: #3b82f6; border-color: #3b82f6; }

        /* Toast */
        .toast { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) translateY(-100px); background: #0f172a; color: white; padding: 12px 24px; rounded: 99px; font-size: 0.9rem; font-weight: 600; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;}
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(20px); }

        /* 編輯模式 */
        .check-overlay { display: none; }
        .edit-mode .check-overlay { display: flex; }
        .edit-mode .log-card { transform: scale(0.96); opacity: 0.8; }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="toast" class="toast"><i class="fa-solid fa-circle-check text-green-400"></i> <span id="toastMsg">已儲存</span></div>

    <!-- Header -->
    <div class="glass-header p-4 flex justify-between items-center">
        <div class="flex items-center gap-3" onclick="switchView('viewDashboard')">
            <div class="w-1.5 h-6 bg-blue-600 rounded-sm"></div>
            <div>
                <h1 class="font-bold tracking-tight text-sm uppercase text-slate-500 dark:text-slate-400">Duty Log</h1>
                <div class="font-mono text-xs font-bold leading-none tracking-wide">LITE v4.2</div>
            </div>
        </div>
        <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 transition border border-slate-200 dark:border-slate-700">
            <i id="themeIcon" class="fa-solid fa-moon text-slate-500 dark:text-slate-400"></i>
        </button>
    </div>

    <!-- 1. Dashboard (首頁) -->
    <div id="viewDashboard" class="view-panel active container mx-auto p-4 max-w-lg">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="switchView('viewFire')" class="bg-white dark:bg-slate-800 p-5 rounded-2xl border-l-4 border-red-500 shadow-sm active:scale-95 transition cursor-pointer flex flex-col items-center gap-2 group relative overflow-hidden">
                <div class="w-12 h-12 rounded-xl bg-red-50 dark:bg-red-900/20 flex items-center justify-center text-red-500 text-2xl"><i class="fa-solid fa-fire"></i></div>
                <div class="font-bold text-slate-800 dark:text-white">火警登錄</div>
            </div>
            <div onclick="switchView('viewEms')" class="bg-white dark:bg-slate-800 p-5 rounded-2xl border-l-4 border-teal-500 shadow-sm active:scale-95 transition cursor-pointer flex flex-col items-center gap-2 group relative overflow-hidden">
                <div class="w-12 h-12 rounded-xl bg-teal-50 dark:bg-teal-900/20 flex items-center justify-center text-teal-500 text-2xl"><i class="fa-solid fa-heart-pulse"></i></div>
                <div class="font-bold text-slate-800 dark:text-white">救護登錄</div>
            </div>
        </div>

        <!-- 統計 -->
        <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 mb-6 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-sm text-slate-600 dark:text-slate-300">本月統計</h3>
                <span class="text-xs font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500" id="currentMonth"></span>
            </div>
            <div class="flex items-center gap-4">
                <div class="w-20 h-20 flex-shrink-0 relative">
                    <canvas id="miniChart"></canvas>
                </div>
                <div class="flex-1 grid grid-cols-2 gap-y-2">
                    <div><div class="text-[10px] text-slate-400 uppercase font-bold">Fire</div><div class="text-lg font-mono font-bold text-red-500" id="dashFire">0</div></div>
                    <div><div class="text-[10px] text-slate-400 uppercase font-bold">EMS</div><div class="text-lg font-mono font-bold text-teal-500" id="dashEms">0</div></div>
                    <div class="col-span-2 border-t border-slate-100 dark:border-slate-800 pt-1 mt-1 flex justify-between">
                        <span class="text-xs text-slate-500">Total</span>
                        <span class="text-lg font-mono font-bold text-slate-800 dark:text-white" id="dashTotal">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-between items-end mb-2 ml-1">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">最近紀錄</div>
            <button onclick="switchView('viewHistory')" class="text-xs text-blue-500 font-bold">查看全部</button>
        </div>
        <div id="recentList" class="space-y-2"></div>
    </div>

    <!-- 2. Fire Form -->
    <div id="viewFire" class="view-panel container mx-auto p-4 max-w-lg">
        <div class="flex items-center gap-3 mb-4">
            <button onclick="switchView('viewDashboard')" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-slate-500"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="text-lg font-bold text-slate-800 dark:text-white">新增火警</h2>
        </div>
        
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-4 space-y-4">
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="datetime-local" id="fireDate" class="font-mono text-sm">
                    <button onclick="setNow('fireDate')" class="bg-slate-100 dark:bg-slate-800 px-3 rounded-lg text-xs font-bold w-16 border border-slate-200 dark:border-slate-700">現在</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="fireLocation" placeholder="地點" required>
                    <button onclick="getGPS('fireLocation')" class="bg-slate-100 dark:bg-slate-800 px-3 rounded-lg text-slate-500 border border-slate-200 dark:border-slate-700"><i class="fa-solid fa-location-crosshairs"></i></button>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">案件類型</label>
                <input type="hidden" id="fireType">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">住宅火警</button>
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">工廠倉庫</button>
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">雜草廢棄物</button>
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">車輛火警</button>
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">誤報/謊報</button>
                    <button onclick="setBtn(this, 'fireType')" class="sys-btn">查看/其他</button>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">狀況與車輛</label>
                <div class="flex gap-2 mb-2">
                    <input type="hidden" id="fireStatus">
                    <button onclick="setBtn(this, 'fireStatus')" class="sys-btn flex-1">成災</button>
                    <button onclick="setBtn(this, 'fireStatus')" class="sys-btn flex-1">未成災</button>
                    <button onclick="setBtn(this, 'fireStatus')" class="sys-btn flex-1">誤報</button>
                </div>
                <input type="text" id="fireVehicles" placeholder="出勤車輛 (如: 11, 91)" class="font-mono uppercase">
            </div>
            <button onclick="saveFire()" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition mt-2">儲存紀錄</button>
        </div>
    </div>

    <!-- 3. EMS Form -->
    <div id="viewEms" class="view-panel container mx-auto p-4 max-w-lg">
        <div class="flex items-center gap-3 mb-4">
            <button onclick="switchView('viewDashboard')" class="w-9 h-9 rounded-full bg-white dark:bg-slate-800 shadow-sm flex items-center justify-center text-slate-500"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="text-lg font-bold text-slate-800 dark:text-white">新增救護</h2>
        </div>
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-4 space-y-4">
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="datetime-local" id="emsDate" class="font-mono text-sm">
                    <button onclick="setNow('emsDate')" class="bg-slate-100 dark:bg-slate-800 px-3 rounded-lg text-xs font-bold w-16 border border-slate-200 dark:border-slate-700">現在</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="emsLocation" placeholder="地點" required>
                    <button onclick="getGPS('emsLocation')" class="bg-slate-100 dark:bg-slate-800 px-3 rounded-lg text-slate-500 border border-slate-200 dark:border-slate-700"><i class="fa-solid fa-location-crosshairs"></i></button>
                </div>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">案件類型</label>
                <input type="hidden" id="emsType">
                <div class="flex flex-wrap gap-2">
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">內科急病</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">車禍</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">創傷</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">路倒</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm font-bold text-red-500 border-red-200">OHCA</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">急產</button>
                    <button onclick="setEmsType(this)" class="sys-btn px-4 rounded-full text-sm">精神</button>
                </div>
            </div>
            <div>
                <div class="flex gap-2 mb-2"><input type="text" id="emsReason" placeholder="主訴" class="flex-1"><input type="text" id="emsHospital" placeholder="送往醫院" class="w-1/3"></div>
                <textarea id="emsNote" rows="3" placeholder="備註..." class="w-full"></textarea>
            </div>
            <button onclick="saveEms()" class="w-full py-3 bg-teal-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition text-lg mt-2">儲存紀錄</button>
        </div>
    </div>

    <!-- 4. History View -->
    <div id="viewHistory" class="view-panel container mx-auto p-4 max-w-lg">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-slate-800 dark:text-white">勤務資料庫</h2>
            <button id="editToggleBtn" onclick="toggleEditMode()" class="text-xs font-bold text-blue-500 bg-blue-50 dark:bg-blue-900/30 px-3 py-1.5 rounded-lg border border-blue-100 dark:border-blue-800">編輯</button>
        </div>

        <div class="flex gap-2 mb-3">
            <input type="month" id="monthFilter" onchange="renderList()" class="bg-white border dark:border-slate-700 rounded-lg text-xs p-2 font-mono w-32 dark:bg-slate-800 shadow-sm">
            <div class="flex flex-1 gap-1">
                <button onclick="filterType('all', this)" class="tag-btn active flex-1 text-center bg-slate-700 text-white border-transparent">全部</button>
                <button onclick="filterType('fire', this)" class="tag-btn flex-1 text-center">火警</button>
                <button onclick="filterType('ems', this)" class="tag-btn flex-1 text-center">救護</button>
            </div>
        </div>

        <!-- 修正的搜尋框 (垂直置中) -->
        <div class="search-wrapper mb-4">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" onkeyup="renderList()" placeholder="搜尋日期、地點、類別..." class="search-input">
        </div>

        <div id="historyList" class="space-y-3 pb-20"></div>

        <!-- 批量刪除 -->
        <div id="batchAction" class="fixed bottom-[80px] left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md p-4 shadow-lg border-t dark:border-slate-700 z-40 hidden">
            <div class="container mx-auto max-w-lg flex justify-between items-center">
                <span class="text-sm font-bold text-slate-600 dark:text-slate-300">已選 <span id="selectCount" class="text-red-500">0</span> 筆</span>
                <button onclick="deleteSelected()" class="bg-red-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-red-600">刪除</button>
            </div>
        </div>
        
        <!-- 資料管理 -->
        <div class="bg-white border border-slate-200 dark:border-slate-700 p-4 rounded-xl shadow-sm mt-6 dark:bg-slate-800">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">DATA MANAGEMENT</div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm font-bold shadow flex items-center justify-center gap-2"><i class="fa-solid fa-file-excel"></i> 匯出 Excel</button>
                <button onclick="exportData()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm font-bold shadow flex items-center justify-center gap-2"><i class="fa-solid fa-download"></i> 備份 JSON</button>
            </div>
            <div class="mt-3">
                <button onclick="document.getElementById('importFile').click()" class="w-full bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-500 py-2 rounded-lg text-sm font-bold border border-amber-200 dark:border-amber-800 flex items-center justify-center gap-2"><i class="fa-solid fa-file-import"></i> 還原備份</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
            </div>
        </div>
    </div>

    <!-- 底部導航 -->
    <nav class="nav-bar">
        <button onclick="switchView('viewDashboard')" class="nav-btn active" id="nav-dash"><i class="fa-solid fa-grip-vertical"></i><span>首頁</span></button>
        <button onclick="switchView('viewFire')" class="nav-btn" id="nav-fire"><i class="fa-solid fa-fire"></i><span>火警</span></button>
        <button onclick="switchView('viewEms')" class="nav-btn" id="nav-ems"><i class="fa-solid fa-heart-pulse"></i><span>救護</span></button>
        <button onclick="switchView('viewHistory')" class="nav-btn" id="nav-hist"><i class="fa-solid fa-folder-open"></i><span>紀錄</span></button>
    </nav>

    <script>
        let logs = []; 
        try { logs = JSON.parse(localStorage.getItem('fireLogLite')) || []; } catch(e) { localStorage.removeItem('fireLogLite'); }
        let currentFilter = 'all', isEdit = false, selIds = new Set(), curLog = null, isDark = localStorage.getItem('fireTheme') === 'dark';
        let chartInst = null;

        window.onload = () => {
            if(isDark) document.documentElement.classList.add('dark');
            updateIcon(); updateDash(); 
            // 修正：不預設帶入月份，確保顯示所有資料
            document.getElementById('monthFilter').value = ""; 
            updateStorage();
        };

        function toggleTheme() { isDark=!isDark; document.documentElement.classList.toggle('dark'); localStorage.setItem('fireTheme', isDark?'dark':'light'); updateIcon(); }
        function updateIcon() { document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon'; }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

        function switchView(id) {
            document.querySelectorAll('.view-panel').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            const map={'viewDashboard':'nav-dash','viewFire':'nav-fire','viewEms':'nav-ems','viewHistory':'nav-hist'};
            if(map[id]) document.getElementById(map[id]).classList.add('active');
            
            if(id==='viewFire' || id==='viewEms') {
                if(!document.getElementById(id==='viewFire'?'fireDate':'emsDate').value) {
                     const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
                     const t = now.toISOString().slice(0,16);
                     if(id==='viewFire') document.getElementById('fireDate').value = t;
                     if(id==='viewEms') document.getElementById('emsDate').value = t;
                }
            }
            if(id==='viewHistory') {
                document.getElementById('searchInput').value = '';
                // 每次進入列表強制清空月份篩選，避免看不到資料
                document.getElementById('monthFilter').value = "";
                renderList();
            }
            if(id==='viewDashboard') updateDash();
            if(id!=='viewHistory') { isEdit=false; selIds.clear(); updateEditUI(); }
        }

        // Reset Forms
        function resetForm(vid) {
            document.querySelectorAll(`#${vid} input:not([type=hidden])`).forEach(i=>i.value='');
            document.querySelectorAll(`#${vid} textarea`).forEach(i=>i.value='');
            document.querySelectorAll(`#${vid} .sys-btn`).forEach(b=>b.classList.remove('active'));
            if(vid==='viewFire') { document.getElementById('fireType').value=''; document.getElementById('fireStatus').value=''; }
            if(vid==='viewEms') { document.getElementById('emsType').value=''; }
        }

        // Logic
        function setBtn(btn, id) { Array.from(btn.parentElement.children).forEach(c=>c.classList.remove('active')); btn.classList.add('active'); document.getElementById(id).value=btn.innerText; if(navigator.vibrate) navigator.vibrate(5); }
        function setEmsType(btn) { setBtn(btn,'emsType'); }
        function setGCS(type, val, btn) { document.getElementById('val'+type).value=val; Array.from(btn.parentElement.children).forEach(c=>c.classList.remove('active')); btn.classList.add('active'); if(navigator.vibrate) navigator.vibrate(5); }
        function addTag(txt) { const n=document.getElementById('emsNote'); n.value+=(n.value?'，':'')+txt; }
        function setNow(id) { const n=new Date(); n.setMinutes(n.getMinutes()-n.getTimezoneOffset()); document.getElementById(id).value=n.toISOString().slice(0,16); }
        function getGPS(id) { if(!navigator.geolocation)return alert('無法定位'); navigator.geolocation.getCurrentPosition(p=>{const c=`${p.coords.latitude.toFixed(4)},${p.coords.longitude.toFixed(4)}`;const i=document.getElementById(id);i.value=i.value?i.value+` (${c})`:c;},e=>alert('定位失敗')); }
        
        function saveFire() {
            if(!document.getElementById('fireType').value) return alert('請選擇類型');
            const l = { id: Date.now(), cat:'fire', date:document.getElementById('fireDate').value, type:document.getElementById('fireType').value, loc:document.getElementById('fireLocation').value, car:document.getElementById('fireVehicles').value, res:document.getElementById('fireStatus').value };
            pushLog(l, 'viewFire');
        }
        function saveEms() {
            if(!document.getElementById('emsType').value) return alert('請選擇類型');
            const l = { id: Date.now(), cat:'ems', date:document.getElementById('emsDate').value, type:document.getElementById('emsType').value, loc:document.getElementById('emsLocation').value, main:document.getElementById('emsReason').value, to:document.getElementById('emsHospital').value, note:document.getElementById('emsNote').value, vitals: `SpO2:${document.getElementById('vitalSpo2').value||'-'}% BP:${document.getElementById('vitalBp').value||'-'} HR:${document.getElementById('vitalHr').value||'-'}` };
            pushLog(l, 'viewEms');
        }
        function pushLog(l, formId) {
            try { 
                logs.unshift(l); localStorage.setItem('fireLogLite', JSON.stringify(logs)); 
                resetForm(formId); 
                showToast('已儲存，可繼續輸入'); 
                // 儲存後不跳轉，但確保重新整理數據
                updateDash();
            } catch(e) { alert('儲存空間不足'); }
        }

        // Dashboard
        function updateDash() {
            document.getElementById('dashTotal').innerText = logs.length;
            const nFire = logs.filter(l=>l.cat==='fire').length;
            const nEms = logs.filter(l=>l.cat==='ems').length;
            document.getElementById('dashFire').innerText = nFire;
            document.getElementById('dashEms').innerText = nEms;
            
            const now = new Date(); const m = now.getMonth()+1;
            document.getElementById('currentMonth').innerText = `${now.getFullYear()}/${m}月`;
            const thisMonthLogs = logs.filter(l => new Date(l.date).getMonth()+1 === m);
            const mFire = thisMonthLogs.filter(l=>l.cat==='fire').length;
            const mEms = thisMonthLogs.filter(l=>l.cat==='ems').length;

            updateChart(mFire, mEms);

            const list = document.getElementById('recentList'); list.innerHTML='';
            logs.slice(0,3).forEach(l => {
                const c = l.cat==='fire'?'text-red-500':'text-teal-500';
                const i = l.cat==='fire'?'fa-fire':'fa-heart-pulse';
                list.innerHTML += `<div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 flex justify-between shadow-sm"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-50 dark:bg-slate-700/50"><i class="fa-solid ${i} ${c}"></i></div><div><div class="font-bold text-sm text-slate-700 dark:text-slate-200">${l.type}</div><div class="text-[10px] text-slate-400 font-mono">${l.date.replace('T', ' ')}</div></div></div></div>`;
            });
        }

        function updateChart(f, e) {
            const ctx = document.getElementById('miniChart').getContext('2d');
            if(chartInst) chartInst.destroy();
            chartInst = new Chart(ctx, { type: 'doughnut', data: { labels: ['火警','救護'], datasets:[{data:[f, e], backgroundColor:['#ef4444','#0d9488'], borderWidth:0}] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, cutout:'70%' } });
        }

        function updateStorage() {
            let total = 0; for(let x in localStorage) { if(localStorage.hasOwnProperty(x)) total += (localStorage[x].length * 2)/1024/1024; }
            console.log(`Used: ${total.toFixed(2)} MB`);
        }

        function renderList() {
            const list = document.getElementById('historyList'); 
            const key = document.getElementById('searchInput').value.toLowerCase(); 
            const month = document.getElementById('monthFilter').value; // YYYY-MM
            list.innerHTML = ''; list.className = isEdit ? 'space-y-3 edit-mode' : 'space-y-3';
            
            const filtered = logs.filter(l => {
                if(currentFilter!=='all' && l.cat!==currentFilter) return false;
                // 如果 month 有值才篩選，空白則顯示所有
                if(month && !l.date.startsWith(month)) return false;
                return JSON.stringify(l).toLowerCase().includes(key);
            });

            if(filtered.length===0) { list.innerHTML='<div class="text-center text-gray-400 mt-10">無資料</div>'; return; }

            filtered.forEach(l => {
                // 優化：拆分日期與時間，避免擠壓
                const dateParts = l.date.split('T');
                const dateStr = dateParts[0]; // YYYY-MM-DD
                const timeStr = dateParts[1]; // HH:mm
                
                const clr = l.cat==='fire'?'border-l-fire':'border-l-ems';
                const tag = l.cat==='fire'?'text-red-500 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded':'text-teal-500 bg-teal-50 dark:bg-teal-900/20 px-2 py-0.5 rounded';
                const sub = l.cat==='fire'?`${l.car||'-'} | ${l.res||'-'}` : `${l.main||'-'} > ${l.to||'-'}`;
                const sel = selIds.has(l.id) ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-slate-200 dark:border-slate-700';

                list.innerHTML += `
                    <div onclick="clickItem(${l.id})" class="log-card relative cursor-pointer transition ${sel} ${clr}">
                        <div class="check-overlay absolute inset-0 bg-white/50 dark:bg-black/50 items-center justify-end pr-4 ${selIds.has(l.id)?'opacity-100':'opacity-0'}"><div class="w-6 h-6 rounded-full border-2 border-slate-400 flex items-center justify-center ${selIds.has(l.id)?'bg-blue-500 border-blue-500':''}"><i class="fa-solid fa-check text-white text-xs"></i></div></div>
                        
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider ${tag} mt-1">${l.type}</span>
                            <div class="text-right">
                                <div class="font-mono font-bold text-slate-700 dark:text-slate-300 text-sm">${dateStr}</div>
                                <div class="font-mono text-xs text-slate-400">${timeStr}</div>
                            </div>
                        </div>
                        <div class="card-title mb-1">${l.loc||'-'}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate">${sub}</div>
                    </div>`;
            });
        }

        function clickItem(id) { if(isEdit) { if(selIds.has(id)) selIds.delete(id); else selIds.add(id); renderList(); document.getElementById('selectCount').innerText=selIds.size; } else { /* No detail view in Lite v4 */ } }

        function toggleEdit() { isEdit=!isEdit; selIds.clear(); document.getElementById('batchAction').classList.toggle('hidden', !isEdit); document.getElementById('editToggleBtn').innerText = isEdit ? '完成' : '編輯'; renderList(); }
        function deleteSelected() { if(confirm(`刪除 ${selIds.size} 筆？`)) { logs=logs.filter(l=>!selIds.has(l.id)); localStorage.setItem('fireLogLite', JSON.stringify(logs)); toggleEdit(); renderList(); updateDash(); } }
        function filterType(t, btn) { currentFilter=t; document.querySelectorAll('.tag-btn').forEach(b=>{ b.classList.remove('active','bg-slate-700','text-white'); b.classList.add('bg-white','text-slate-600','border'); }); btn.classList.remove('bg-white','text-slate-600','border'); btn.classList.add('active','bg-slate-700','text-white'); renderList(); }

        function exportCSV() { if(!logs.length) return alert('無資料'); let csv = "\uFEFF日期,時間,類別,細項,地點,主訴/結果,送往/車輛,備註\n"; logs.forEach(l=>{ const dt=l.date.split('T'); const row=[dt[0], dt[1], l.cat==='fire'?'火警':'救護', l.type, `"${l.loc}"`, l.cat==='fire'?l.res:l.main, l.cat==='fire'?l.car:l.to, `"${l.cat==='ems'?l.note:''}"`]; csv+=row.join(",")+"\n"; }); const a=document.createElement('a'); a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv); a.download=`FireLog.csv`; document.body.appendChild(a); a.click(); a.remove(); }
        function exportJSON() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(logs)); a.download=`FireLog_Backup.json`; document.body.appendChild(a); a.click(); a.remove(); }
        function triggerImport(){document.getElementById('importFile').click();}
        function importData(inp) { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(confirm(`還原 ${d.length} 筆？舊資料將被覆蓋！`)){ logs=d; localStorage.setItem('fireLogLite', JSON.stringify(logs)); location.reload(); } } catch(e){alert('檔案錯誤');} }; r.readAsText(f); }
    </script>
</body>
</html>
