<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireLog Pro v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <style>
        /* åŸºç¤è¨­å®š */
        body { font-family: 'Inter', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* è¦–åœ–åˆ‡æ›å‹•ç•« */
        .view-panel { display: none; }
        .view-panel.active { display: block; animation: fadeUpdate 0.2s ease-out; }
        @keyframes fadeUpdate { from { opacity: 0.8; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å…ƒä»¶æ¨£å¼ */
        .sys-btn { border: 1px solid #e2e8f0; background: white; color: #475569; transition: all 0.1s; }
        .sys-btn.active { background: #334155; color: white; border-color: #334155; font-weight: 600; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .dark .sys-btn { background: #1e293b; border-color: #334155; color: #94a3b8; }
        .dark .sys-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        
        .glass-header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .photo-preview { background-size: cover; background-position: center; }

        /* æˆ°è¡“ç•«æ¿ Grid (ä¿®æ­£ç‰ˆ) */
        .tac-wrapper { width: 100%; max-width: 350px; margin: 0 auto; aspect-ratio: 1/1; }
        .tac-grid { 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            grid-template-rows: repeat(8, 1fr);
            gap: 1px; 
            background: #475569; 
            border: 2px solid #475569;
            width: 100%;
            height: 100%;
        }
        .tac-cell { 
            background: #1e293b; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 1.2rem; /* åœ–ç¤ºå¤§å° */
        }
        .tac-cell:active { background: #334155; }
        
        /* å·¥å…·æŒ‰éˆ•é¸ä¸­æ¨£å¼ */
        .tool-btn.active { ring-width: 2px; ring-color: #facc15; transform: scale(1.1); }

        /* æˆ°è¡“åœ–ç¤ºå®šç¾© */
        .icon-fire { color: #ef4444; animation: pulse 1s infinite; }
        .icon-smoke { color: #94a3b8; opacity: 0.8; }
        .icon-house { color: #cbd5e1; }
        .icon-factory { color: #a5b4fc; }
        .icon-grass { color: #84cc16; }
        .icon-hydrant { color: #fbbf24; }
        .icon-car { color: #f87171; text-shadow: 0 0 2px black; }
        .icon-water { color: #3b82f6; font-size: 0.8rem !important; } /* æ°´ç·šç´°ä¸€é» */
        .icon-victim { color: #facc15; animation: bounce 1s infinite; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }

        /* ç·¨è¼¯é¸å–® */
        .check-overlay { display: none; }
        .edit-mode .check-overlay { display: flex; }
        .edit-mode .log-card { transform: scale(0.98); }
        
        /* Dark Mode Colors */
        .dark .bg-slate-50 { background-color: #0f172a; }
        .dark .bg-white { background-color: #1e293b; color: #f1f5f9; }
        .dark input, .dark textarea, .dark select { background-color: #0f172a; border-color: #334155; color: white; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-24 transition-colors duration-300">

    <!-- Header -->
    <div class="glass-header text-white p-3 sticky top-0 z-50 shadow-md border-b border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-2" onclick="switchView('viewDashboard')">
            <div class="w-2 h-6 bg-orange-500 rounded-sm"></div>
            <h1 class="font-bold tracking-wider text-sm">FIRE COMMAND <span class="text-xs opacity-50 font-mono">v5.1</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()" class="text-slate-400 hover:text-white transition"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
            <div class="text-xs font-mono text-slate-400" id="sysTime">00:00</div>
        </div>
    </div>

    <!-- 1. Dashboard -->
    <div id="viewDashboard" class="view-panel active container mx-auto p-3 max-w-lg">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div onclick="switchView('viewFire')" class="bg-white p-4 rounded border-l-4 border-red-500 shadow-sm active:scale-95 transition cursor-pointer dark:border-red-600">
                <div class="flex justify-between mb-2"><i class="fa-solid fa-fire text-red-500 text-xl"></i><span class="text-xs font-bold text-slate-400">NEW</span></div>
                <div class="text-xl font-bold text-slate-800 dark:text-white">ç«è­¦ç™»éŒ„</div>
                <div class="text-xs text-slate-500 mt-1">å«æˆ°è¡“ç•«æ¿</div>
            </div>
            <div onclick="switchView('viewEms')" class="bg-white p-4 rounded border-l-4 border-teal-500 shadow-sm active:scale-95 transition cursor-pointer dark:border-teal-600">
                <div class="flex justify-between mb-2"><i class="fa-solid fa-heart-pulse text-teal-500 text-xl"></i><span class="text-xs font-bold text-slate-400">NEW</span></div>
                <div class="text-xl font-bold text-slate-800 dark:text-white">æ•‘è­·ç™»éŒ„</div>
                <div class="text-xs text-slate-500 mt-1">PCR å¿«é€Ÿé¸å–®</div>
            </div>
        </div>

        <div class="bg-slate-800 text-white p-4 rounded shadow-sm mb-4 flex justify-between items-center cursor-pointer active:opacity-90" onclick="switchView('viewHistory')">
            <div><div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Total Cases</div><div class="text-2xl font-mono font-bold" id="dashTotal">0</div></div>
            <div class="flex gap-4 text-right">
                <div><div class="text-[10px] text-red-400">FIRE</div><div class="font-mono font-bold" id="dashFire">0</div></div>
                <div><div class="text-[10px] text-teal-400">EMS</div><div class="font-mono font-bold" id="dashEms">0</div></div>
                <div class="flex items-center text-slate-500"><i class="fa-solid fa-chevron-right"></i></div>
            </div>
        </div>

        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">Recent Logs</div>
        <div id="recentList" class="space-y-2"></div>
    </div>

    <!-- 2. Fire Form -->
    <div id="viewFire" class="view-panel container mx-auto p-3 max-w-lg">
        <div class="bg-white rounded shadow-sm border border-slate-200 overflow-hidden dark:border-slate-700">
            <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center dark:border-slate-700">
                <span class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-fire text-red-500 mr-2"></i>ç«è­¦æ¡ˆä»¶</span>
                <button onclick="switchView('viewDashboard')" class="text-slate-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <form onsubmit="saveFire(event)" class="p-4 space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <div class="col-span-3"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Time & Loc</label><input type="datetime-local" id="fireDate" class="w-full p-2 bg-slate-50 border rounded text-sm font-mono"></div>
                    <div class="col-span-3"><input type="text" id="fireLocation" placeholder="åœ°é»" class="w-full p-2 border rounded text-sm" required></div>
                </div>
                
                <!-- æˆ°è¡“ç•«æ¿å…¥å£ -->
                <div class="bg-slate-800 p-3 rounded text-center">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Tactical Board (å…µæ£‹æ¨æ¼”)</label>
                    <button type="button" onclick="openTacticsEditor()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-3 px-4 rounded w-full flex items-center justify-center gap-2 shadow-lg active:scale-95 transition">
                        <i class="fa-solid fa-pen-ruler"></i> é»æ“Šç¹ªè£½ç¾å ´åœ–
                    </button>
                    <div id="tacticsStatus" class="text-[10px] text-green-400 mt-2 hidden font-bold"><i class="fa-solid fa-check"></i> å·²å„²å­˜æˆ°è¡“åœ–</div>
                    <input type="hidden" id="fireTacticsData">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">My Role</label>
                    <input type="hidden" id="fireRole">
                    <div class="grid grid-cols-4 gap-2">
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">ç„å­æ‰‹</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">å‰¯ç„å­</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">å¸¶éšŠå®˜</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">å¸æ©Ÿ</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">æœæ•‘</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">æ°´æº</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">å‚³ä»¤</button>
                        <button type="button" onclick="setBtn(this, 'fireRole')" class="sys-btn p-2 rounded text-xs">å…¶ä»–</button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Type</label>
                    <input type="hidden" id="fireType">
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">ä½å®…ç«è­¦</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">å·¥å» å€‰åº«</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">é›œè‰å»¢æ£„ç‰©</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">è»Šè¼›ç«è­¦</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">é«˜å±¤å»ºç¯‰</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">èª¤å ±/è¬Šå ±</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">èˆ¹èˆ¶èˆªç©º</button>
                        <button type="button" onclick="setBtn(this, 'fireType')" class="sys-btn p-3 rounded text-sm text-left">å…¶ä»–</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Vehicles</label><input type="text" id="fireVehicles" placeholder="11, 91" class="w-full p-2 border rounded text-sm font-mono uppercase"></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Result</label><select id="fireStatus" class="w-full p-2 border rounded text-sm bg-white dark:bg-slate-800"><option value="æˆç½">æˆç½</option><option value="æœªæˆç½">æœªæˆç½</option><option value="èª¤å ±">èª¤å ±</option><option value="æŸ¥çœ‹">æŸ¥çœ‹</option></select></div>
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Photo</label>
                    <div class="flex items-center gap-3">
                        <label class="flex flex-col items-center justify-center w-20 h-20 border-2 border-dashed border-slate-300 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800"><i class="fa-solid fa-camera text-slate-400"></i><input type="file" accept="image/*" class="hidden" onchange="handlePhoto(this, 'firePhotoPreview', 'firePhotoData')"></label>
                        <div id="firePhotoPreview" class="w-20 h-20 rounded border bg-slate-100 photo-preview hidden" onclick="clearPhoto('firePhotoPreview', 'firePhotoData')"></div>
                        <input type="hidden" id="firePhotoData">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-slate-800 text-white rounded font-bold hover:bg-slate-900 mt-4 dark:bg-blue-600">CONFIRM ENTRY</button>
            </form>
        </div>
    </div>

    <!-- 3. EMS Form -->
    <div id="viewEms" class="view-panel container mx-auto p-3 max-w-lg">
        <div class="bg-white rounded shadow-sm border border-slate-200 dark:border-slate-700">
            <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center dark:border-slate-700">
                <span class="font-bold text-slate-700 dark:text-slate-200"><i class="fa-solid fa-heart-pulse text-teal-500 mr-2"></i>æ•‘è­·ç´€éŒ„è¡¨</span>
                <button onclick="switchView('viewDashboard')" class="text-slate-400"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <form onsubmit="saveEms(event)" class="p-3 space-y-4">
                <div class="flex gap-2">
                    <input type="datetime-local" id="emsDate" class="w-1/2 p-2 bg-slate-50 border rounded text-xs font-mono">
                    <input type="text" id="emsLocation" placeholder="åœ°é»" class="w-1/2 p-2 border rounded text-xs" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">My Role</label>
                    <input type="hidden" id="emsRole">
                    <div class="flex gap-2">
                        <button type="button" onclick="setBtn(this, 'emsRole')" class="sys-btn flex-1 p-2 rounded text-xs text-center">ä¸»æ‰‹</button>
                        <button type="button" onclick="setBtn(this, 'emsRole')" class="sys-btn flex-1 p-2 rounded text-xs text-center">å‰¯æ‰‹</button>
                        <button type="button" onclick="setBtn(this, 'emsRole')" class="sys-btn flex-1 p-2 rounded text-xs text-center">é§•é§›</button>
                        <button type="button" onclick="setBtn(this, 'emsRole')" class="sys-btn flex-1 p-2 rounded text-xs text-center">å¯¦ç¿’</button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Case Type</label>
                    <input type="hidden" id="emsType">
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">å…§ç§‘æ€¥ç—…</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">è»Šç¦ (MVA)</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">ä¸€èˆ¬å‰µå‚·</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">è·¯å€’</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">OHCA</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">æ€¥ç”¢</button>
                        <button type="button" onclick="setEmsType(this)" class="sys-btn ems-tag rounded-full px-3">ç²¾ç¥</button>
                    </div>
                </div>
                <div id="roscSection" class="hidden bg-red-50 p-3 rounded border border-red-100 flex justify-between items-center dark:bg-red-900/20 dark:border-red-800">
                    <span class="text-sm font-bold text-red-700 flex items-center gap-2 dark:text-red-400"><i class="fa-solid fa-heart-pulse"></i> ROSC (æ¢å¾©å¿ƒè·³)</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="isRosc" id="isRosc" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/><label for="isRosc" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer dark:bg-slate-600"></label></div>
                </div>
                <div class="bg-slate-50 p-3 rounded border border-slate-200 space-y-2 dark:border-slate-700">
                    <div class="flex items-center gap-2"><span class="text-xs font-bold w-10">GCS:</span><div class="flex-1 flex gap-1"><input type="text" id="gcsE" placeholder="E" class="w-1/3 p-1 text-center border text-xs font-mono" maxlength="1"><input type="text" id="gcsV" placeholder="V" class="w-1/3 p-1 text-center border text-xs font-mono" maxlength="1"><input type="text" id="gcsM" placeholder="M" class="w-1/3 p-1 text-center border text-xs font-mono" maxlength="1"></div></div>
                    <div class="flex gap-2"><div class="flex-1"><div class="text-[10px] text-gray-400">SpO2</div><input type="number" id="vitalSpo2" placeholder="%" class="w-full p-1 border text-sm font-mono"></div><div class="flex-1"><div class="text-[10px] text-gray-400">BP</div><input type="text" id="vitalBp" placeholder="SYS/DIA" class="w-full p-1 border text-sm font-mono"></div><div class="flex-1"><div class="text-[10px] text-gray-400">HR</div><input type="number" id="vitalHr" placeholder="BPM" class="w-full p-1 border text-sm font-mono"></div></div>
                </div>
                <div>
                    <div class="flex gap-2 mb-2"><input type="text" id="emsReason" placeholder="ä¸»è¨´" class="flex-1 p-2 border rounded text-sm"><input type="text" id="emsHospital" placeholder="é€å¾€é†«é™¢" class="w-1/3 p-2 border rounded text-sm"></div>
                    <div class="flex flex-wrap gap-1 mb-2"><button type="button" onclick="appendNote('O2é¢ç½©')" class="text-[10px] bg-white border px-2 py-1 rounded dark:text-slate-300 dark:border-slate-600">+O2</button><button type="button" onclick="appendNote('IVå»ºç«‹')" class="text-[10px] bg-white border px-2 py-1 rounded dark:text-slate-300 dark:border-slate-600">+IV</button><button type="button" onclick="appendNote('é ¸åœˆé•·èƒŒæ¿')" class="text-[10px] bg-white border px-2 py-1 rounded dark:text-slate-300 dark:border-slate-600">+é ¸åœˆ</button><button type="button" onclick="appendNote('AEDç›£æ¸¬')" class="text-[10px] bg-white border px-2 py-1 rounded dark:text-slate-300 dark:border-slate-600">+AED</button><button type="button" onclick="appendNote('æ‹’é€')" class="text-[10px] bg-red-50 border border-red-200 text-red-600 px-2 py-1 rounded dark:bg-red-900/30 dark:border-red-800 dark:text-red-300">+æ‹’é€</button></div>
                    <textarea id="emsNote" rows="2" class="w-full p-2 border rounded text-sm" placeholder="å‚™è¨»..."></textarea>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Photo</label>
                    <div class="flex items-center gap-3">
                        <label class="flex flex-col items-center justify-center w-20 h-20 border-2 border-dashed border-slate-300 rounded cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800"><i class="fa-solid fa-camera text-slate-400"></i><input type="file" accept="image/*" class="hidden" onchange="handlePhoto(this, 'emsPhotoPreview', 'emsPhotoData')"></label>
                        <div id="emsPhotoPreview" class="w-20 h-20 rounded border bg-slate-100 photo-preview hidden" onclick="clearPhoto('emsPhotoPreview', 'emsPhotoData')"></div>
                        <input type="hidden" id="emsPhotoData">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 bg-teal-600 text-white rounded font-bold hover:bg-teal-700 shadow-md">SAVE RECORD</button>
            </form>
        </div>
    </div>

    <!-- 4. History -->
    <div id="viewHistory" class="view-panel container mx-auto p-3 max-w-lg">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2"><button onclick="switchView('viewDashboard')" class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center text-slate-600 hover:bg-slate-100 dark:text-slate-300"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-lg font-bold text-slate-800 dark:text-slate-200">å‹¤å‹™è³‡æ–™åº«</h2></div>
            <button id="editToggleBtn" onclick="toggleEditMode()" class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded border border-blue-100 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300"><i class="fa-solid fa-list-check mr-1"></i> ç·¨è¼¯</button>
        </div>
        <div id="historyStatsBar" class="bg-slate-800 text-white p-3 rounded mb-3 text-xs flex justify-around font-mono"></div>
        <div class="flex gap-2 mb-3">
            <input type="month" id="monthFilter" onchange="renderList()" class="bg-white border rounded text-xs p-2 font-mono w-32 dark:bg-slate-800 dark:border-slate-600">
            <div class="flex flex-1 gap-1">
                <button onclick="filterType('all', this)" class="filter-btn active flex-1 bg-slate-700 text-white text-xs font-bold rounded">å…¨éƒ¨</button>
                <button onclick="filterType('fire', this)" class="filter-btn flex-1 bg-white text-slate-600 border text-xs font-bold rounded dark:bg-slate-800 dark:text-slate-300 dark:border-slate-600">ç«è­¦</button>
                <button onclick="filterType('ems', this)" class="filter-btn flex-1 bg-white text-slate-600 border text-xs font-bold rounded dark:bg-slate-800 dark:text-slate-300 dark:border-slate-600">æ•‘è­·</button>
            </div>
        </div>
        <div class="relative mb-4"><i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-sm"></i><input type="text" id="searchInput" onkeyup="renderList()" placeholder="Search..." class="w-full pl-9 p-2 bg-white border rounded text-sm outline-none dark:bg-slate-800 dark:border-slate-600"></div>
        <div id="historyList" class="space-y-3 pb-40"></div>
        <div id="batchAction" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t z-50 hidden dark:bg-slate-900 dark:border-slate-700">
            <div class="container mx-auto max-w-lg flex justify-between items-center"><span class="text-sm text-slate-600 font-bold dark:text-slate-300">é¸å– <span id="selectCount" class="text-red-500">0</span> ç­†</span><button onclick="deleteSelected()" class="bg-red-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-red-700">åˆªé™¤</button></div>
        </div>
        <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm mt-6 dark:bg-slate-800 dark:border-slate-700">
            <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-database text-slate-400"></i><span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Data Management</span></div>
            <div class="grid grid-cols-2 gap-3"><button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm font-bold gap-2 flex justify-center shadow"><i class="fa-solid fa-file-excel"></i> Excel</button><button onclick="exportData()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-sm font-bold gap-2 flex justify-center shadow"><i class="fa-solid fa-file-export"></i> JSON</button></div>
            <div class="mt-3"><button onclick="triggerImport()" class="w-full bg-amber-50 border border-amber-200 text-amber-700 hover:bg-amber-100 py-2 rounded text-sm font-bold flex justify-center gap-2 dark:bg-amber-900/20 dark:border-amber-800 dark:text-amber-500"><i class="fa-solid fa-file-import"></i> é‚„åŸ</button><input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)"></div>
        </div>
    </div>

    <!-- 5. æˆ°è¡“ç•«æ¿ Modal (5.1 FIXED) -->
    <div id="viewTacticsEditor" class="fixed inset-0 bg-slate-900 z-[70] hidden flex flex-col">
        <div class="p-3 bg-slate-800 text-white flex justify-between items-center border-b border-slate-700">
            <h3 class="font-bold">æˆ°è¡“ç¹ªåœ–æ¿ (8x8)</h3>
            <button onclick="closeTactics()" class="text-slate-400 p-2"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-900 w-full overflow-hidden">
            
            <!-- æˆ°è¡“ç¶²æ ¼ (ç¢ºä¿æ­£æ–¹å½¢ä¸”å¯è¦‹) -->
            <div class="tac-wrapper mb-4">
                <div class="tac-grid" id="tacticsGrid">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å·¥å…·åˆ— -->
            <div class="w-full max-w-[350px]">
                <div class="flex gap-3 p-2 bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-x-auto justify-between mb-3">
                    <button onclick="setTool('house')" class="tool-btn w-10 h-10 rounded-lg bg-slate-700 text-slate-300 flex items-center justify-center"><i class="fa-solid fa-house"></i></button>
                    <button onclick="setTool('factory')" class="tool-btn w-10 h-10 rounded-lg bg-slate-700 text-indigo-300 flex items-center justify-center"><i class="fa-solid fa-industry"></i></button>
                    <button onclick="setTool('grass')" class="tool-btn w-10 h-10 rounded-lg bg-slate-700 text-lime-400 flex items-center justify-center"><i class="fa-solid fa-tree"></i></button>
                    <button onclick="setTool('fire')" class="tool-btn w-10 h-10 rounded-lg bg-red-900/50 text-red-500 border border-red-900 flex items-center justify-center"><i class="fa-solid fa-fire"></i></button>
                    <button onclick="setTool('smoke')" class="tool-btn w-10 h-10 rounded-lg bg-slate-600 text-slate-300 flex items-center justify-center"><i class="fa-solid fa-cloud"></i></button>
                </div>
                <div class="flex gap-3 p-2 bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-x-auto justify-between">
                    <button onclick="setTool('car')" class="tool-btn w-10 h-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center"><i class="fa-solid fa-truck"></i></button>
                    <button onclick="setTool('water')" class="tool-btn w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-faucet-drip"></i></button>
                    <button onclick="setTool('hydrant')" class="tool-btn w-10 h-10 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center"><i class="fa-solid fa-fire-hydrant"></i></button>
                    <button onclick="setTool('victim')" class="tool-btn w-10 h-10 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center"><i class="fa-solid fa-person-falling"></i></button>
                    <button onclick="setTool('empty')" class="tool-btn w-10 h-10 rounded-lg bg-slate-900 text-slate-500 border border-slate-700 flex items-center justify-center"><i class="fa-solid fa-eraser"></i></button>
                </div>
            </div>
            
            <div class="flex justify-between w-full max-w-[350px] mt-2">
                <span class="text-[10px] text-slate-500">é»é¸å·¥å…· -> é»æ“Šæ ¼å­</span>
                <button onclick="clearTactics()" class="text-[10px] text-red-400 underline">æ¸…ç©ºç•«å¸ƒ</button>
            </div>
        </div>
        <div class="p-4 bg-slate-800 border-t border-slate-700 sticky bottom-0">
            <button onclick="saveTactics()" class="w-full py-3 bg-blue-600 text-white rounded font-bold shadow-lg hover:bg-blue-700">ç¢ºèªå„²å­˜åœ–é¢</button>
        </div>
    </div>

    <!-- 6. è©³ç´°é é¢ (å«æˆ°è¡“åœ–) -->
    <div id="viewDetail" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-[60] hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-lg h-[90vh] sm:h-auto sm:rounded-xl rounded-t-xl overflow-y-auto shadow-2xl relative animate-[slideUp_0.3s_ease-out] dark:bg-slate-800">
            <div class="sticky top-0 bg-white/95 backdrop-blur border-b p-4 flex justify-between items-center z-10 dark:bg-slate-800/95 dark:border-slate-700">
                <h3 class="font-bold text-slate-800 text-lg dark:text-white">æ¡ˆä»¶è©³æƒ…</h3>
                <button onclick="closeDetail()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="detailContent" class="p-5 space-y-4"></div>
            <div class="p-4 border-t bg-slate-50 sticky bottom-0 flex gap-2 dark:bg-slate-900 dark:border-slate-700">
                <button onclick="copyDetail()" class="flex-1 py-3 bg-blue-600 text-white rounded font-bold shadow hover:bg-blue-700"><i class="fa-solid fa-copy mr-2"></i>æ‘˜è¦</button>
                <button onclick="closeDetail()" class="flex-1 py-3 bg-slate-800 text-white rounded font-bold hover:bg-slate-900 dark:bg-slate-700">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        let logs = JSON.parse(localStorage.getItem('fireLogPro')) || [];
        let currentFilter = 'all';
        let isEditMode = false;
        let selectedIds = new Set();
        let currentDetailLog = null;
        let isDark = localStorage.getItem('fireLogTheme') === 'dark';
        
        // æˆ°è¡“è®Šæ•¸
        let currentTactics = Array(64).fill('empty');
        let currentTool = 'fire'; // é è¨­å·¥å…·

        window.onload = () => { 
            if(isDark) document.documentElement.classList.add('dark');
            updateThemeIcon();
            updateTime(); updateDashboard(); setInterval(updateTime, 1000); 
            document.getElementById('monthFilter').value = new Date().toISOString().slice(0, 7);
            initTacticsGrid();
        };
        
        function updateTime() { document.getElementById('sysTime').innerText = new Date().toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit'}); }
        function toggleTheme() { isDark = !isDark; document.documentElement.classList.toggle('dark'); localStorage.setItem('fireLogTheme', isDark ? 'dark' : 'light'); updateThemeIcon(); }
        function updateThemeIcon() { document.getElementById('themeIcon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon'; }

        function switchView(viewId) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            if(viewId !== 'viewHistory') { isEditMode = false; selectedIds.clear(); updateEditUI(); }
            if (viewId === 'viewFire' || viewId === 'viewEms') {
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                const t = now.toISOString().slice(0,16);
                if(viewId === 'viewFire') { 
                    document.getElementById('fireDate').value = t; 
                    clearPhoto('firePhotoPreview', 'firePhotoData');
                    document.querySelectorAll('#viewFire .sys-btn').forEach(b => b.classList.remove('active'));
                    document.getElementById('fireTacticsData').value = '';
                    document.getElementById('tacticsStatus').classList.add('hidden');
                    currentTactics.fill('empty');
                }
                if(viewId === 'viewEms') { 
                    document.getElementById('emsDate').value = t; 
                    clearPhoto('emsPhotoPreview', 'emsPhotoData'); 
                    document.getElementById('roscSection').classList.add('hidden');
                    document.getElementById('isRosc').checked = false;
                    document.querySelectorAll('#viewEms .sys-btn').forEach(b => b.classList.remove('active'));
                }
            }
            if (viewId === 'viewHistory') { renderList(); }
            if (viewId === 'viewDashboard') { updateDashboard(); }
        }

        // === æˆ°è¡“ç•«æ¿é‚è¼¯ (v5.1 Fixed) ===
        function initTacticsGrid() {
            const grid = document.getElementById('tacticsGrid');
            grid.innerHTML = '';
            for(let i=0; i<64; i++) {
                const cell = document.createElement('div');
                cell.className = 'tac-cell';
                cell.dataset.idx = i;
                cell.onclick = () => { 
                    currentTactics[i] = currentTool; 
                    renderTacticsCell(cell, currentTool);
                };
                grid.appendChild(cell);
            }
        }
        function renderTacticsCell(el, type) {
            const icons = {
                'empty': '', 
                'house': '<i class="fa-solid fa-house icon-house"></i>',
                'factory': '<i class="fa-solid fa-industry icon-factory"></i>',
                'grass': '<i class="fa-solid fa-tree icon-grass"></i>',
                'fire': '<i class="fa-solid fa-fire icon-fire"></i>',
                'smoke': '<i class="fa-solid fa-cloud icon-smoke"></i>',
                'car': '<i class="fa-solid fa-truck icon-car"></i>',
                'water': '<i class="fa-solid fa-faucet-drip icon-water"></i>',
                'hydrant': '<i class="fa-solid fa-fire-hydrant icon-hydrant"></i>',
                'victim': '<i class="fa-solid fa-person-falling icon-victim"></i>',
                'ems': '<i class="fa-solid fa-truck-medical icon-ems"></i>'
            };
            el.innerHTML = icons[type] || '';
        }
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        function clearTactics() {
            if(confirm('ç¢ºå®šæ¸…ç©ºç•«å¸ƒï¼Ÿ')) {
                currentTactics.fill('empty');
                const cells = document.querySelectorAll('#tacticsGrid .tac-cell');
                cells.forEach(c => c.innerHTML = '');
            }
        }
        function openTacticsEditor() {
            const existing = document.getElementById('fireTacticsData').value;
            if(existing) currentTactics = JSON.parse(existing);
            else currentTactics.fill('empty');
            
            const cells = document.querySelectorAll('#tacticsGrid .tac-cell');
            cells.forEach((c, i) => renderTacticsCell(c, currentTactics[i]));
            
            document.getElementById('viewTacticsEditor').classList.remove('hidden');
        }
        function saveTactics() {
            document.getElementById('fireTacticsData').value = JSON.stringify(currentTactics);
            document.getElementById('tacticsStatus').classList.remove('hidden');
            closeTactics();
        }
        function closeTactics() { document.getElementById('viewTacticsEditor').classList.add('hidden'); }

        // === è¡¨å–®é‚è¼¯ ===
        function handlePhoto(input, prevId, dataId) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image(); img.onload = () => {
                    const cvs = document.createElement('canvas'); const MAX=800;
                    let w=img.width, h=img.height; if(w>h){if(w>MAX){h*=MAX/w;w=MAX}}else{if(h>MAX){w*=MAX/h;h=MAX}}
                    cvs.width=w; cvs.height=h; const ctx=cvs.getContext('2d'); ctx.drawImage(img,0,0,w,h);
                    const d = cvs.toDataURL('image/jpeg',0.6);
                    document.getElementById(dataId).value = d;
                    const p = document.getElementById(prevId); p.style.backgroundImage=`url(${d})`; p.classList.remove('hidden');
                }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        }
        function clearPhoto(pid, did) { document.getElementById(did).value=''; document.getElementById(pid).classList.add('hidden'); }
        function setBtn(btn, id) { Array.from(btn.parentElement.children).forEach(c=>c.classList.remove('active')); btn.classList.add('active'); document.getElementById(id).value=btn.innerText; }
        
        function setEmsType(btn) {
            setBtn(btn, 'emsType');
            const roscDiv = document.getElementById('roscSection');
            if(btn.innerText === 'OHCA') roscDiv.classList.remove('hidden');
            else { roscDiv.classList.add('hidden'); document.getElementById('isRosc').checked = false; }
        }
        function appendNote(t) { const n=document.getElementById('emsNote'); n.value+=(n.value?' ':'')+t; }

        function saveFire(e) {
            e.preventDefault(); if(!document.getElementById('fireType').value) return alert('è«‹é¸æ“‡ç¨®é¡');
            saveLog({
                id: Date.now(), cat: 'fire', date: document.getElementById('fireDate').value,
                type: document.getElementById('fireType').value, loc: document.getElementById('fireLocation').value,
                car: document.getElementById('fireVehicles').value, res: document.getElementById('fireStatus').value,
                role: document.getElementById('fireRole').value || 'æœªå¡«',
                photo: document.getElementById('firePhotoData').value,
                tactics: document.getElementById('fireTacticsData').value
            });
        }
        function saveEms(e) {
            e.preventDefault(); if(!document.getElementById('emsType').value) return alert('è«‹é¸æ“‡ç¨®é¡');
            const gcs = `E${document.getElementById('gcsE').value}V${document.getElementById('gcsV').value}M${document.getElementById('gcsM').value}`;
            saveLog({
                id: Date.now(), cat: 'ems', date: document.getElementById('emsDate').value,
                type: document.getElementById('emsType').value, loc: document.getElementById('emsLocation').value,
                main: document.getElementById('emsReason').value, to: document.getElementById('emsHospital').value,
                note: document.getElementById('emsNote').value, 
                vitals: `GCS:${gcs.length>3?gcs:'-'} SpO2:${document.getElementById('vitalSpo2').value||'-'} BP:${document.getElementById('vitalBp').value||'-'}`,
                role: document.getElementById('emsRole').value || 'æœªå¡«',
                photo: document.getElementById('emsPhotoData').value,
                rosc: document.getElementById('isRosc').checked
            });
        }
        function saveLog(l) {
            logs.unshift(l); try { localStorage.setItem('fireLogPro', JSON.stringify(logs)); document.querySelectorAll('input:not([type=hidden])').forEach(i=>i.value=''); document.querySelectorAll('textarea').forEach(i=>i.value=''); switchView('viewDashboard'); } 
            catch(e){ alert('ç©ºé–“ä¸è¶³ï¼Œè«‹å‚™ä»½å¾Œåˆªé™¤èˆŠè³‡æ–™'); logs.shift(); }
        }

        // === æ­·å²èˆ‡çµ±è¨ˆ ===
        function updateDashboard() {
            document.getElementById('dashTotal').innerText = logs.length;
            document.getElementById('dashFire').innerText = logs.filter(l=>l.cat==='fire').length;
            document.getElementById('dashEms').innerText = logs.filter(l=>l.cat==='ems').length;
            const list = document.getElementById('recentList'); list.innerHTML='';
            logs.slice(0,3).forEach(l => {
                const c = l.cat==='fire'?'text-red-500':'text-teal-500';
                list.innerHTML+=`<div class="bg-white p-2 rounded border border-slate-100 flex justify-between shadow-sm dark:bg-slate-800 dark:border-slate-700"><div class="flex items-center gap-3"><i class="fa-solid fa-circle text-[8px] ${c}"></i><div><div class="font-bold text-sm text-slate-700 dark:text-slate-200">${l.type}</div><div class="text-[10px] text-slate-400 font-mono">${l.date.slice(5,10)}</div></div></div></div>`;
            });
        }

        function renderList() {
            const list = document.getElementById('historyList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const month = document.getElementById('monthFilter').value;
            list.innerHTML = ''; list.className = isEditMode ? 'space-y-3 edit-mode' : 'space-y-3';
            const filtered = logs.filter(l => {
                if(currentFilter!=='all' && l.cat!==currentFilter) return false;
                if(month && !l.date.startsWith(month)) return false;
                return JSON.stringify(l).toLowerCase().includes(search);
            });
            const nFire = filtered.filter(l=>l.cat==='fire').length;
            const nEms = filtered.filter(l=>l.cat==='ems').length;
            const nRosc = filtered.filter(l=>l.rosc).length;
            document.getElementById('historyStatsBar').innerHTML = `<span>ç¸½è¨ˆ: ${filtered.length}</span><span>ğŸ”¥ ${nFire}</span><span>ğŸš‘ ${nEms}</span><span class="text-red-400">â¤ï¸ ${nRosc}</span>`;
            if(filtered.length === 0) { list.innerHTML='<div class="text-center text-gray-400 mt-10">ç„¡è³‡æ–™</div>'; return; }
            filtered.forEach(log => {
                const d = new Date(log.date);
                const ds = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                const clr = log.cat==='fire' ? 'border-red-500' : 'border-teal-500';
                const tag = log.cat==='fire' ? 'bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400' : 'bg-teal-50 text-teal-600 dark:bg-teal-900/30 dark:text-teal-400';
                const desc = log.cat==='fire' ? `${log.car||'-'} | ${log.res}` : `${log.main||'-'} > ${log.to||'-'}`;
                const sel = selectedIds.has(log.id) ? 'bg-blue-50 border-blue-500 dark:bg-blue-900/30 dark:border-blue-500' : 'bg-white dark:bg-slate-800 dark:border-slate-700';
                const roscIcon = log.rosc ? '<i class="fa-solid fa-heart text-red-500 ml-1 animate-pulse"></i>' : '';
                list.innerHTML += `<div onclick="handleItemClick(${log.id})" class="log-card p-3 rounded border-l-4 ${clr} shadow-sm relative cursor-pointer transition ${sel}"><div class="check-overlay absolute inset-0 bg-white/50 items-center justify-end pr-4 ${selectedIds.has(log.id)?'opacity-100':'opacity-0 hover:opacity-100'} dark:bg-black/50"><div class="w-6 h-6 rounded-full border-2 border-slate-400 flex items-center justify-center ${selectedIds.has(log.id)?'bg-blue-500 border-blue-500':''}"><i class="fa-solid fa-check text-white text-xs"></i></div></div><div class="flex justify-between mb-1"><span class="${tag} text-[10px] px-1 rounded font-bold uppercase">${log.type} ${roscIcon}</span><span class="text-xs font-mono text-slate-400">${ds}</span></div><div class="font-bold text-slate-800 dark:text-slate-200">${log.loc}</div><div class="text-xs text-slate-500 mt-1 truncate dark:text-slate-400">${desc}</div>${(log.photo||log.tactics)?'<div class="absolute top-2 right-2 text-slate-300"><i class="fa-solid fa-paperclip"></i></div>':''}</div>`;
            });
        }

        function handleItemClick(id) { if(isEditMode) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderList(); document.getElementById('selectCount').innerText = selectedIds.size; } else { showDetail(id); } }
        
        function showDetail(id) {
            const l = logs.find(log => log.id === id); currentDetailLog = l;
            const ds = new Date(l.date).toLocaleString('zh-TW');
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.loc)}`;
            
            let tacticsHtml = '';
            if(l.tactics) {
                const tacData = JSON.parse(l.tactics);
                const icons = {'empty':'','house':'<i class="fa-solid fa-house icon-house"></i>','factory':'<i class="fa-solid fa-industry icon-factory"></i>','grass':'<i class="fa-solid fa-tree icon-grass"></i>','fire':'<i class="fa-solid fa-fire icon-fire"></i>','smoke':'<i class="fa-solid fa-cloud icon-smoke"></i>','car':'<i class="fa-solid fa-truck icon-car"></i>','water':'<i class="fa-solid fa-faucet-drip icon-water"></i>','hydrant':'<i class="fa-solid fa-fire-hydrant icon-hydrant"></i>','victim':'<i class="fa-solid fa-person-falling icon-victim"></i>','ems':'<i class="fa-solid fa-truck-medical icon-ems"></i>'};
                let gridStr = '';
                tacData.forEach(type => gridStr += `<div class="tac-cell">${icons[type]||''}</div>`);
                tacticsHtml = `<div class="mt-4"><div class="text-xs text-slate-400 mb-1">æˆ°è¡“ä½ˆç½²åœ–</div><div class="tac-wrapper"><div class="tac-grid">${gridStr}</div></div></div>`;
            }

            let h = '';
            if(l.cat === 'fire') {
                h = `${l.photo ? `<img src="${l.photo}" class="w-full h-48 object-cover rounded-lg mb-4 border dark:border-slate-600">` : ''}
                    <div class="grid grid-cols-2 gap-4 text-sm dark:text-slate-300"><div><div class="text-xs text-slate-400">é¡å‹</div><div class="font-bold text-red-500">ç«è­¦ - ${l.type}</div></div><div><div class="text-xs text-slate-400">æ™‚é–“</div><div class="font-mono">${ds}</div></div><div class="col-span-2"><div class="text-xs text-slate-400">åœ°é»</div><a href="${mapLink}" target="_blank" class="font-bold text-lg text-blue-600 hover:underline dark:text-blue-400">${l.loc} <i class="fa-solid fa-map-location-dot ml-1 text-sm"></i></a></div><div><div class="text-xs text-slate-400">æˆ‘çš„ä»»å‹™</div><div class="font-bold bg-slate-100 inline-block px-2 rounded dark:bg-slate-700">${l.role}</div></div><div><div class="text-xs text-slate-400">è»Šè¼›</div><div>${l.car||'ç„¡'}</div></div><div><div class="text-xs text-slate-400">çµæœ</div><div class="font-bold text-red-600 dark:text-red-400">${l.res}</div></div></div>
                    ${tacticsHtml}`;
            } else {
                h = `${l.photo ? `<img src="${l.photo}" class="w-full h-48 object-cover rounded-lg mb-4 border dark:border-slate-600">` : ''}
                    <div class="grid grid-cols-2 gap-4 text-sm dark:text-slate-300"><div><div class="text-xs text-slate-400">é¡å‹</div><div class="font-bold flex items-center gap-1 text-teal-500">æ•‘è­· - ${l.type} ${l.rosc?'<i class="fa-solid fa-heart text-red-500"></i>':''}</div></div><div><div class="text-xs text-slate-400">æ™‚é–“</div><div class="font-mono">${ds}</div></div><div class="col-span-2"><div class="text-xs text-slate-400">åœ°é»</div><a href="${mapLink}" target="_blank" class="font-bold text-lg text-blue-600 hover:underline dark:text-blue-400">${l.loc} <i class="fa-solid fa-map-location-dot ml-1 text-sm"></i></a></div><div class="col-span-2 bg-slate-50 p-2 rounded border dark:bg-slate-700 dark:border-slate-600"><div class="text-xs text-slate-400">ç”Ÿå‘½å¾µè±¡</div><div class="font-mono font-bold">${l.vitals}</div></div><div><div class="text-xs text-slate-400">æˆ‘çš„ä»»å‹™</div><div class="font-bold bg-slate-100 inline-block px-2 rounded dark:bg-slate-700">${l.role}</div></div><div><div class="text-xs text-slate-400">ä¸»è¨´</div><div>${l.main||'-'}</div></div><div><div class="text-xs text-slate-400">é€å¾€</div><div>${l.to||'-'}</div></div><div class="col-span-2"><div class="text-xs text-slate-400">å‚™è¨»/è™•ç½®</div><div class="text-slate-600 dark:text-slate-400">${l.note||'ç„¡'}</div></div></div>`;
            }
            document.getElementById('detailContent').innerHTML = h;
            document.getElementById('viewDetail').classList.remove('hidden');
        }
        function closeDetail() { document.getElementById('viewDetail').classList.add('hidden'); }
        
        function copyDetail() {
            const l = currentDetailLog; if(!l) return;
            const t = l.cat==='fire' 
                ? `ã€ç«è­¦æ¡ˆä»¶ã€‘\næ™‚é–“ï¼š${l.date.replace('T',' ')}\nåœ°é»ï¼š${l.loc}\né¡å‹ï¼š${l.type}\nä»»å‹™ï¼š${l.role}\nè»Šè¼›ï¼š${l.car}\nç‹€æ³ï¼š${l.res}`
                : `ã€æ•‘è­·æ¡ˆä»¶ã€‘\næ™‚é–“ï¼š${l.date.replace('T',' ')}\nåœ°é»ï¼š${l.loc}\né¡å‹ï¼š${l.type}${l.rosc?' (ROSC)':''}\nä»»å‹™ï¼š${l.role}\nä¸»è¨´ï¼š${l.main}\né€å¾€ï¼š${l.to}\nå¾µè±¡ï¼š${l.vitals}\nå‚™è¨»ï¼š${l.note}`;
            navigator.clipboard.writeText(t).then(()=>alert('å·²è¤‡è£½æ–‡å­—æ‘˜è¦ï¼'));
        }

        function toggleEditMode() { isEditMode=!isEditMode; updateEditUI(); selectedIds.clear(); renderList(); }
        function updateEditUI() { 
            const b=document.getElementById('editToggleBtn'), a=document.getElementById('batchAction');
            if(isEditMode){ b.classList.replace('bg-blue-50','bg-slate-800'); b.classList.replace('text-blue-600','text-white'); b.innerHTML='<i class="fa-solid fa-check"></i> å®Œæˆ'; a.classList.remove('hidden'); }
            else { b.classList.replace('bg-slate-800','bg-blue-50'); b.classList.replace('text-white','text-blue-600'); b.innerHTML='<i class="fa-solid fa-list-check"></i> ç·¨è¼¯'; a.classList.add('hidden'); }
        }
        function deleteSelected() {
            if(selectedIds.size===0) return alert('æœªé¸æ“‡');
            if(confirm(`åˆªé™¤ ${selectedIds.size} ç­†ç´€éŒ„ï¼Ÿ`)) {
                logs=logs.filter(l=>!selectedIds.has(l.id)); localStorage.setItem('fireLogPro',JSON.stringify(logs));
                toggleEditMode(); renderList(); updateDashboard();
            }
        }
        function filterType(t,b) {
            currentFilter=t; document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.remove('bg-slate-700','text-white');btn.classList.add('bg-white','text-slate-600')});
            b.classList.remove('bg-white','text-slate-600'); b.classList.add('bg-slate-700','text-white'); renderList();
        }

        function exportData() {
            const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(logs));
            a.download=`FireLog_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove();
        }
        function exportCSV() {
            if(logs.length===0) return alert('ç„¡è³‡æ–™');
            let csv = "\uFEFFæ—¥æœŸ,æ™‚é–“,é¡åˆ¥,ç´°é …,ä»»å‹™,åœ°é»,ä¸»è¨´/çµæœ,é€å¾€/è»Šè¼›,å‚™è¨»\n";
            logs.forEach(l => {
                const dt = l.date.split('T');
                const row = [dt[0], dt[1], l.cat==='fire'?'ç«è­¦':'æ•‘è­·', l.type + (l.rosc?'(ROSC)':''), l.role, `"${l.loc}"`, l.cat==='fire'?l.res:l.main, l.cat==='fire'?l.car:l.to, `"${l.cat==='ems'?l.note:''}"`];
                csv += row.join(",") + "\n";
            });
            const a=document.createElement('a'); a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
            a.download=`FireLog_Export_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
        }
        function triggerImport(){document.getElementById('importFile').click();}
        function importData(inp){
            const f=inp.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{
                try{ const d=JSON.parse(e.target.result); if(confirm(`é‚„åŸ ${d.length} ç­†è³‡æ–™ï¼Ÿ`)){logs=d;localStorage.setItem('fireLogPro',JSON.stringify(logs));location.reload();} }
                catch(err){alert('æª”æ¡ˆéŒ¯èª¤');}
            }; r.readAsText(f);
        }
    </script>
</body>
</html>
