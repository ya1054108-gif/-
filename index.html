<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç«æ—¥è¨˜ - å‹¤å‹™ç´€éŒ„èˆ‡æª¢è¨</title>
    <!-- ä½¿ç”¨ Tailwind CSS å¿«é€Ÿåˆ‡ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .type-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; }
        .bg-fire { background-color: #ef4444; } /* ç«è­¦ç´… */
        .bg-ems { background-color: #10b981; } /* æ•‘è­·ç¶  */
        .bg-rescue { background-color: #f59e0b; } /* æ¶æ•‘æ©˜ */
        .bg-service { background-color: #3b82f6; } /* ç‚ºæ°‘æœå‹™è— */
        .bg-drill { background-color: #6b7280; } /* è¨“ç·´ç° */
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- å°èˆªåˆ— -->
    <nav class="bg-slate-800 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-fire-extinguisher mr-2"></i>æ‰“ç«æ—¥è¨˜</h1>
            <button onclick="exportData()" class="text-sm bg-slate-600 px-3 py-1 rounded hover:bg-slate-500">
                <i class="fa-solid fa-download"></i> å‚™ä»½
            </button>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-2xl">
        
        <!-- æ–°å¢æŒ‰éˆ•å€ -->
        <div class="mb-6 flex gap-2">
            <input type="text" id="searchInput" placeholder="æœå°‹æ¡ˆä»¶ (å¦‚: OHCA, å·¥å» ...)" class="flex-grow p-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-red-500 outline-none" onkeyup="renderLogs()">
            <button onclick="toggleModal()" class="bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg hover:bg-red-700 font-bold whitespace-nowrap">
                <i class="fa-solid fa-plus"></i> æ–°å¢ç´€éŒ„
            </button>
        </div>

        <!-- çµ±è¨ˆå°å¡ -->
        <div class="grid grid-cols-3 gap-4 mb-6 text-center text-white">
            <div class="bg-slate-700 p-3 rounded-lg shadow">
                <div class="text-xs opacity-75">ç¸½å‹¤å‹™æ•¸</div>
                <div class="text-xl font-bold" id="totalCount">0</div>
            </div>
            <div class="bg-red-500 p-3 rounded-lg shadow">
                <div class="text-xs opacity-75">ç«è­¦</div>
                <div class="text-xl font-bold" id="fireCount">0</div>
            </div>
            <div class="bg-emerald-500 p-3 rounded-lg shadow">
                <div class="text-xs opacity-75">æ•‘è­·</div>
                <div class="text-xl font-bold" id="emsCount">0</div>
            </div>
        </div>

        <!-- ç´€éŒ„åˆ—è¡¨ -->
        <div id="logList" class="space-y-4">
            <!-- é€™è£¡æœƒç”± JavaScript è‡ªå‹•ç”Ÿæˆå…§å®¹ -->
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯ è¦–çª— (Modal) -->
    <div id="entryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h2 class="text-lg font-bold text-slate-800">æ–°å¢å‹¤å‹™ç´€éŒ„</h2>
                <button onclick="toggleModal()" class="text-gray-500 hover:text-red-500 text-xl">&times;</button>
            </div>
            
            <form id="logForm" class="p-4 space-y-4" onsubmit="saveLog(event)">
                <input type="hidden" id="logId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸæ™‚é–“</label>
                        <input type="datetime-local" id="logDate" required class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¡å‹</label>
                        <select id="logType" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="ç«è­¦">ğŸ”¥ ç«è­¦</option>
                            <option value="æ•‘è­·">ğŸš‘ æ•‘è­·</option>
                            <option value="æ¶æ•‘">ğŸ§— æ¶æ•‘</option>
                            <option value="ç‚ºæ°‘æœå‹™">ğŸ ç‚ºæ°‘æœå‹™</option>
                            <option value="è¨“ç·´">ğŸƒ è¨“ç·´/æ¼”ç¿’</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åœ°é» / ä»£è™Ÿ</label>
                    <input type="text" id="logLocation" placeholder="ä¾‹å¦‚ï¼šä¸­å±±è·¯ä¸€æ®µ / 01æ¡ˆä»¶" class="w-full p-2 border rounded outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¡ˆä»¶æ‘˜è¦</label>
                    <input type="text" id="logTitle" required placeholder="ä¾‹å¦‚ï¼šä½å®…ç«è­¦ã€è»Šç¦OHCA" class="w-full p-2 border rounded outline-none font-bold">
                </div>

                <!-- æ ¸å¿ƒç­†è¨˜å€ -->
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <label class="block text-sm font-bold text-yellow-800 mb-1"><i class="fa-solid fa-lightbulb"></i> æª¢è¨èˆ‡æ³¨æ„äº‹é … (æœ€é‡è¦)</label>
                    <textarea id="logNotes" rows="4" class="w-full p-2 border rounded outline-none text-sm" placeholder="é€™æ¬¡å­¸åˆ°äº†ä»€éº¼ï¼Ÿè£å‚™å“ªè£¡æœ‰å•é¡Œï¼Ÿä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…æ³è©²æ³¨æ„ä»€éº¼ï¼Ÿ"></textarea>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="toggleModal()" class="flex-1 py-2 border rounded text-gray-600 hover:bg-gray-100">å–æ¶ˆ</button>
                    <button type="submit" class="flex-1 py-2 bg-slate-800 text-white rounded hover:bg-slate-900">å„²å­˜ç´€éŒ„</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è³‡æ–™
        let logs = JSON.parse(localStorage.getItem('fireLogs')) || [];

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = () => {
            renderLogs();
            updateStats();
        };

        // é–‹é—œ Modal
        function toggleModal(isEdit = false) {
            const modal = document.getElementById('entryModal');
            const form = document.getElementById('logForm');
            modal.classList.toggle('hidden');
            
            if (!modal.classList.contains('hidden') && !isEdit) {
                form.reset();
                document.getElementById('logId').value = '';
                // é è¨­ç•¶ä¸‹æ™‚é–“
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('logDate').value = now.toISOString().slice(0,16);
            }
        }

        // å„²å­˜ç´€éŒ„
        function saveLog(e) {
            e.preventDefault();
            
            const id = document.getElementById('logId').value;
            const logData = {
                id: id ? parseInt(id) : Date.now(),
                date: document.getElementById('logDate').value,
                type: document.getElementById('logType').value,
                location: document.getElementById('logLocation').value,
                title: document.getElementById('logTitle').value,
                notes: document.getElementById('logNotes').value,
            };

            if (id) {
                // ç·¨è¼¯æ¨¡å¼
                const index = logs.findIndex(log => log.id === parseInt(id));
                logs[index] = logData;
            } else {
                // æ–°å¢æ¨¡å¼
                logs.unshift(logData); // åŠ åœ¨æœ€å‰é¢
            }

            localStorage.setItem('fireLogs', JSON.stringify(logs));
            toggleModal();
            renderLogs();
            updateStats();
        }

        // åˆªé™¤ç´€éŒ„
        function deleteLog(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ')) {
                logs = logs.filter(log => log.id !== id);
                localStorage.setItem('fireLogs', JSON.stringify(logs));
                renderLogs();
                updateStats();
            }
        }

        // ç·¨è¼¯ç´€éŒ„
        function editLog(id) {
            const log = logs.find(l => l.id === id);
            if(log) {
                document.getElementById('logId').value = log.id;
                document.getElementById('logDate').value = log.date;
                document.getElementById('logType').value = log.type;
                document.getElementById('logLocation').value = log.location;
                document.getElementById('logTitle').value = log.title;
                document.getElementById('logNotes').value = log.notes;
                toggleModal(true);
            }
        }

        // å–å¾—é¡å‹é¡è‰²
        function getTypeColor(type) {
            switch(type) {
                case 'ç«è­¦': return 'bg-fire';
                case 'æ•‘è­·': return 'bg-ems';
                case 'æ¶æ•‘': return 'bg-rescue';
                case 'ç‚ºæ°‘æœå‹™': return 'bg-service';
                default: return 'bg-drill';
            }
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderLogs() {
            const list = document.getElementById('logList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            list.innerHTML = '';

            const filteredLogs = logs.filter(log => 
                log.title.toLowerCase().includes(search) || 
                log.notes.toLowerCase().includes(search) ||
                log.type.includes(search)
            );

            if (filteredLogs.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡ç´€éŒ„ï¼Œé–‹å§‹ä½ çš„ç¬¬ä¸€ç­†ç´€éŒ„å§ï¼</div>';
                return;
            }

            filteredLogs.forEach(log => {
                const dateObj = new Date(log.date);
                const dateStr = `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2,'0')}/${dateObj.getDate().toString().padStart(2,'0')} ${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border-l-4 ' + (log.type === 'ç«è­¦' ? 'border-red-500' : (log.type === 'æ•‘è­·' ? 'border-emerald-500' : 'border-gray-300'));
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="type-tag ${getTypeColor(log.type)}">${log.type}</span>
                            <span class="text-xs text-gray-500 ml-2">${dateStr}</span>
                        </div>
                        <div>
                            <button onclick="editLog(${log.id})" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteLog(${log.id})" class="text-gray-400 hover:text-red-500 mx-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">${log.title}</h3>
                    ${log.location ? `<div class="text-sm text-gray-500 mb-2"><i class="fa-solid fa-location-dot mr-1"></i>${log.location}</div>` : ''}
                    
                    ${log.notes ? `
                        <div class="mt-3 bg-yellow-50 p-3 rounded text-sm text-gray-700 leading-relaxed whitespace-pre-wrap border border-yellow-100">
                            <strong class="text-yellow-700 block mb-1">æª¢è¨ç­†è¨˜ï¼š</strong>${log.notes}
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            document.getElementById('totalCount').innerText = logs.length;
            document.getElementById('fireCount').innerText = logs.filter(l => l.type === 'ç«è­¦').length;
            document.getElementById('emsCount').innerText = logs.filter(l => l.type === 'æ•‘è­·').length;
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "fire_log_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>